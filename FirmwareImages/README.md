# Firmware Images

Prebuilt application binaries for the ESP32-P4 OpENer EtherNet/IP project. The
images in this directory target the **WaveShare ESP32-P4-NANO** board (with or
without the PoE module) and include:

- OpENer EtherNet/IP adapter with static/DHCP IP selection and Custom ACD
  timings (200 ms probe cycle, four announcements at 2 s interval).
- VL53L1X Time-of-Flight sensor task pinned to core 1, populating Input
  Assembly 100 bytes 0-8 (distance, status, ambient, signal per SPAD, SPAD
  count).
- OpENer, lwIP, and Ethernet stack pinned to core 0 with deferred static IP
  assignment and conflict handling.
- GPIO33 output assembly control (bit 0 of Output Assembly 150) for the status
  LED.
- Configurable TCP/IP settings persisted in NVS via CIP attributes.
- **Web Configuration Interface** (port 80) for sensor configuration, real-time
  status monitoring, and firmware management.
- **Modbus TCP Server** (port 502) providing access to EtherNet/IP assembly
  data via standard Modbus protocol.
- **OTA Firmware Update** capability via web interface for remote firmware
  updates.
- Builds produced with ESP-IDF v5.5 toolchain.
- Sensor I²C defaults wired for the WaveShare board: SDA **GPIO 7**, SCL
  **GPIO 8** (configurable via Kconfig).
- Graceful VL53L1X fallback: if the sensor is not detected during boot, the
  task logs the failure, stops updating Input Assembly 100, and leaves the rest
  of the EtherNet/IP stack running.

## Files

This directory contains automatically generated firmware images with unique names. Each time you build the project using `idf.py build`, the firmware binary is automatically copied here with a timestamp-based filename.

### Automatic Firmware Copying

The build system automatically copies the firmware binary to this directory after each successful build. Firmware images are named using the following format:

- **With Git commit hash**: `ESP32-P4-OpENerEIP_YYYYMMDD_HHMMSS_<git-hash>.bin`
- **Without Git hash**: `ESP32-P4-OpENerEIP_YYYYMMDD_HHMMSS.bin`

Where:
- `YYYYMMDD_HHMMSS` is the build timestamp (year, month, day, hour, minute, second)
- `<git-hash>` is the short (7-character) Git commit hash, if available

Example filenames:
- `ESP32-P4-OpENerEIP_20250115_143022_a1b2c3d.bin`
- `ESP32-P4-OpENerEIP_20250115_143022.bin`

This allows you to maintain a history of firmware builds, making it easy to identify which build corresponds to which source code version and when it was built.

### Manual Firmware Management

- The latest firmware binary can always be found in `build/ESP32-P4-OpENerEIP.bin`
- Older firmware images in this directory can be safely archived or deleted to save disk space
- Each build creates a new firmware image, so you may want to periodically clean up old images
- Bootloader and partition table images are generated by ESP-IDF on demand and
  can be found in the `build/bootloader/` and `build/partition_table/`
  directories if needed

### Finding the Latest Firmware

The most recently built firmware image will have the latest timestamp in its filename. You can identify it by sorting the files by modification date or by the timestamp in the filename.

## Flashing Instructions

1. Install ESP-IDF v5.5 (or later) and ensure `idf.py` is on your PATH.
2. Connect the WaveShare ESP32-P4-NANO via USB (default USB-serial JTAG
   interface).
3. Clone this repository and open a terminal in the project root.
4. Run the following command to flash the firmware:

   ```bash
   idf.py -p <PORT> flash
   ```

   Replace `<PORT>` with the COM port (Windows) or `/dev/ttyACM*`
   (Linux/macOS). The command automatically flashes the bootloader,
   partition table, and `ESP32-P4-OpENerEIP.bin` image.

5. To flash only the application binary from this directory:

   ```bash
   idf.py -p <PORT> app-flash
   ```

   or use `esptool.py` directly with any firmware image from this directory:

   ```bash
   esptool.py --chip esp32p4 --port <PORT> --baud 921600 write_flash \
     0x00010000 FirmwareImages/ESP32-P4-OpENerEIP_YYYYMMDD_HHMMSS.bin
   ```

   Replace the filename with the specific firmware image you want to flash. All firmware images in this directory are ready to flash and include the complete application binary.

6. Open the serial monitor for logs:

   ```bash
   idf.py -p <PORT> monitor
   ```

   Press `Ctrl+]` to exit.

## Board Pinout Reference

![WaveShare ESP32-P4-NANO Pinout](../images/ESP32-P4-NANO-details-inter.jpg)

## Post-Flash Checklist

- Confirm Ethernet link comes up (logs show `ethernet_event: ETH_EVENT_LINK_UP`).
- Verify DHCP/static IP configuration via CIP (TCP/IP Interface object
  attributes) or serial log.
- **Access the Web Interface**: Open `http://<device-ip-address>` in a web
  browser to configure the sensor, view real-time status, or perform firmware
  updates.
- Check VL53L1X sensor output in Input Assembly 100 via EtherNet/IP client.
  If all bytes remain zero and the console shows `VL53L1x initialization
  failed`, inspect sensor power/I²C wiring and reboot once corrected.
- Toggle Output Assembly 150 bit 0 to drive the status LED on GPIO33.
- **Test Modbus TCP**: Connect a Modbus client to port 502 to read sensor data
  from Input Registers 0-15 or write to Holding Registers 100-115.

## Web Configuration Interface

The firmware includes a built-in web server accessible at `http://<device-ip-address>`
(port 80) that provides:

- **Configuration Page**: Configure all VL53L1X sensor parameters (distance mode,
  timing budget, ROI settings, calibration values, thresholds, etc.) with
  persistence to NVS.
- **Status Page**: Real-time sensor readings with an interactive distance-over-time
  chart.
- **Firmware Update Page**: Upload new firmware images via the web browser for
  over-the-air updates.

All configuration changes are validated and immediately applied to the sensor.
See the main [README.md](../README.md) for detailed documentation on the web
interface and API endpoints.

## Modbus TCP Access

The firmware includes a Modbus TCP server on port 502 that provides access to
EtherNet/IP assembly data:

- **Input Registers 0-15**: Read-only access to Input Assembly 100 (sensor data)
- **Holding Registers 100-115**: Read-write access to Output Assembly 150
- **Holding Registers 150-154**: Read-write access to Configuration Assembly 151

The implementation automatically handles endianness conversion between
little-endian (EtherNet/IP) and big-endian (Modbus) formats. See the main
[README.md](../README.md) for detailed register mapping and example code.

## OTA Firmware Updates

Firmware updates can be performed over-the-air via the web interface:

1. Navigate to the Firmware Update page (`http://<device-ip-address>/ota`)
2. Select a `.bin` firmware file (max 2 MB)
3. Click "Start Update" to upload and install the new firmware
4. The device automatically reboots into the new firmware after successful upload

The device includes automatic rollback protection: if the new firmware fails
validation after reboot, it automatically reverts to the previous working version.

### Building and Distributing Firmware

Firmware images are automatically copied to this directory during the build process. Simply run:

```bash
idf.py build
```

The firmware binary will be automatically copied to `FirmwareImages/` with a unique timestamp-based name. You can then distribute any of the firmware images in this directory to other systems or use them for OTA updates.

**Note**: The automatic copying feature uses a Python script (`scripts/copy_firmware.py`) that includes retry logic to handle timing issues during the build process. If you encounter any issues with automatic copying, you can manually copy `build/ESP32-P4-OpENerEIP.bin` to this directory.

