<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VL53L1x Configuration</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding: 20px; background-color: #f5f5f5; }
.container { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
h1 { color: #333; margin-bottom: 30px; }
.form-group { margin-bottom: 20px; }
label { font-weight: 600; color: #555; }
.btn-group { margin-top: 30px; }
</style>
</head>
<body>
<div class="container">
<h1>VL53L1x Sensor Configuration</h1>
<form id="configForm">
<div class="row">
<div class="col-md-6">
<div class="form-group">
<label>Distance Mode</label>
<select class="form-control" id="distance_mode" name="distance_mode">
<option value="1">SHORT (<1.3m)</option>
<option value="2" selected>LONG (<4m)</option>
</select>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label>Timing Budget (ms)</label>
<select class="form-control" id="timing_budget_ms" name="timing_budget_ms">
<option value="15">15</option>
<option value="20">20</option>
<option value="33">33</option>
<option value="50">50</option>
<option value="100" selected>100</option>
<option value="200">200</option>
<option value="500">500</option>
</select>
</div>
</div>
</div>
<div class="form-group">
<label>Inter-Measurement Period (ms)</label>
<input type="number" class="form-control" id="inter_measurement_ms" name="inter_measurement_ms" min="15" step="1" value="100">
</div>
<div class="row">
<div class="col-md-4">
<div class="form-group">
<label>ROI X Size</label>
<input type="number" class="form-control" id="roi_x_size" name="roi_x_size" min="4" max="16" value="16">
</div>
</div>
<div class="col-md-4">
<div class="form-group">
<label>ROI Y Size</label>
<input type="number" class="form-control" id="roi_y_size" name="roi_y_size" min="4" max="16" value="16">
</div>
</div>
<div class="col-md-4">
<div class="form-group">
<label>ROI Center SPAD</label>
<input type="number" class="form-control" id="roi_center_spad" name="roi_center_spad" min="0" max="199" value="199">
</div>
</div>
</div>
<div class="row">
<div class="col-md-6">
<div class="form-group">
<label>Offset (mm)</label>
<div class="input-group">
<input type="number" class="form-control" id="offset_mm" name="offset_mm" min="-128" max="127" value="0">
<button type="button" class="btn btn-secondary" onclick="calibrateOffset()">Calibrate</button>
</div>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label>Xtalk (cps)</label>
<div class="input-group">
<input type="number" class="form-control" id="xtalk_cps" name="xtalk_cps" min="0" max="65535" value="0">
<button type="button" class="btn btn-secondary" onclick="calibrateXtalk()">Calibrate</button>
</div>
</div>
</div>
</div>
<div class="row">
<div class="col-md-6">
<div class="form-group">
<label>Signal Threshold (kcps)</label>
<input type="number" class="form-control" id="signal_threshold_kcps" name="signal_threshold_kcps" min="0" max="65535" value="1024">
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label>Sigma Threshold (mm)</label>
<input type="number" class="form-control" id="sigma_threshold_mm" name="sigma_threshold_mm" min="0" max="65535" value="15">
</div>
</div>
</div>
<div class="row">
<div class="col-md-4">
<div class="form-group">
<label>Threshold Low (mm)</label>
<input type="number" class="form-control" id="threshold_low_mm" name="threshold_low_mm" min="0" max="4000" value="0">
</div>
</div>
<div class="col-md-4">
<div class="form-group">
<label>Threshold High (mm)</label>
<input type="number" class="form-control" id="threshold_high_mm" name="threshold_high_mm" min="0" max="4000" value="0">
</div>
</div>
<div class="col-md-4">
<div class="form-group">
<label>Threshold Window</label>
<select class="form-control" id="threshold_window" name="threshold_window">
<option value="0" selected>Below</option>
<option value="1">Above</option>
<option value="2">Out</option>
<option value="3">In</option>
</select>
</div>
</div>
</div>
<div class="row">
<div class="col-md-6">
<div class="form-group">
<label>Interrupt Polarity</label>
<select class="form-control" id="interrupt_polarity" name="interrupt_polarity">
<option value="0">Active Low</option>
<option value="1" selected>Active High</option>
</select>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label>I2C Address</label>
<input type="text" class="form-control" id="i2c_address" name="i2c_address" pattern="0x[0-9A-Fa-f]{2}" value="0x29">
</div>
</div>
</div>
<div class="btn-group">
<button type="button" class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
<button type="button" class="btn btn-secondary" onclick="loadConfig()">Load Current</button>
<button type="button" class="btn btn-warning" onclick="resetConfig()">Reset to Defaults</button>
<a href="status.html" class="btn btn-info">View Status</a>
<a href="ota.html" class="btn btn-success">OTA Update</a>
</div>
</form>
<div id="message" class="alert" style="display:none; margin-top:20px;"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Mock API for preview
const mockConfig = {
  distance_mode: 2,
  timing_budget_ms: 100,
  inter_measurement_ms: 100,
  roi_x_size: 16,
  roi_y_size: 16,
  roi_center_spad: 199,
  offset_mm: 0,
  xtalk_cps: 0,
  signal_threshold_kcps: 1024,
  sigma_threshold_mm: 15,
  threshold_low_mm: 0,
  threshold_high_mm: 0,
  threshold_window: 0,
  interrupt_polarity: 1,
  i2c_address: 0x29
};

function showMessage(text, type) {
  const msg = document.getElementById('message');
  msg.textContent = text;
  msg.className = 'alert alert-' + type;
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 5000);
}

function loadConfig() {
  // Simulate API call
  setTimeout(() => {
    const data = mockConfig;
    document.getElementById('distance_mode').value = data.distance_mode;
    document.getElementById('timing_budget_ms').value = data.timing_budget_ms;
    document.getElementById('inter_measurement_ms').value = data.inter_measurement_ms;
    document.getElementById('roi_x_size').value = data.roi_x_size;
    document.getElementById('roi_y_size').value = data.roi_y_size;
    document.getElementById('roi_center_spad').value = data.roi_center_spad;
    document.getElementById('offset_mm').value = data.offset_mm;
    document.getElementById('xtalk_cps').value = data.xtalk_cps;
    document.getElementById('signal_threshold_kcps').value = data.signal_threshold_kcps;
    document.getElementById('sigma_threshold_mm').value = data.sigma_threshold_mm;
    document.getElementById('threshold_low_mm').value = data.threshold_low_mm;
    document.getElementById('threshold_high_mm').value = data.threshold_high_mm;
    document.getElementById('threshold_window').value = data.threshold_window;
    document.getElementById('interrupt_polarity').value = data.interrupt_polarity;
    document.getElementById('i2c_address').value = '0x' + data.i2c_address.toString(16).padStart(2, '0');
    showMessage('Configuration loaded (Preview Mode)', 'success');
  }, 100);
}

function saveConfig() {
  const addr = document.getElementById('i2c_address').value;
  const addrNum = parseInt(addr, 16);
  const data = {
    distance_mode: parseInt(document.getElementById('distance_mode').value),
    timing_budget_ms: parseInt(document.getElementById('timing_budget_ms').value),
    inter_measurement_ms: parseInt(document.getElementById('inter_measurement_ms').value),
    roi_x_size: parseInt(document.getElementById('roi_x_size').value),
    roi_y_size: parseInt(document.getElementById('roi_y_size').value),
    roi_center_spad: parseInt(document.getElementById('roi_center_spad').value),
    offset_mm: parseInt(document.getElementById('offset_mm').value),
    xtalk_cps: parseInt(document.getElementById('xtalk_cps').value),
    signal_threshold_kcps: parseInt(document.getElementById('signal_threshold_kcps').value),
    sigma_threshold_mm: parseInt(document.getElementById('sigma_threshold_mm').value),
    threshold_low_mm: parseInt(document.getElementById('threshold_low_mm').value),
    threshold_high_mm: parseInt(document.getElementById('threshold_high_mm').value),
    threshold_window: parseInt(document.getElementById('threshold_window').value),
    interrupt_polarity: parseInt(document.getElementById('interrupt_polarity').value),
    i2c_address: addrNum
  };
  
  // Simulate API call
  setTimeout(() => {
    Object.assign(mockConfig, data);
    showMessage('Configuration saved successfully (Preview Mode - not saved to device)', 'success');
  }, 200);
}

function resetConfig() {
  if (confirm('Reset to default configuration?')) {
    document.getElementById('distance_mode').value = 2;
    document.getElementById('timing_budget_ms').value = 100;
    document.getElementById('inter_measurement_ms').value = 100;
    document.getElementById('roi_x_size').value = 16;
    document.getElementById('roi_y_size').value = 16;
    document.getElementById('roi_center_spad').value = 199;
    document.getElementById('offset_mm').value = 0;
    document.getElementById('xtalk_cps').value = 0;
    document.getElementById('signal_threshold_kcps').value = 1024;
    document.getElementById('sigma_threshold_mm').value = 15;
    document.getElementById('threshold_low_mm').value = 0;
    document.getElementById('threshold_high_mm').value = 0;
    document.getElementById('threshold_window').value = 0;
    document.getElementById('interrupt_polarity').value = 1;
    document.getElementById('i2c_address').value = '0x29';
    showMessage('Form reset to defaults', 'info');
  }
}

function calibrateOffset() {
  const dist = prompt('Enter target distance in mm (recommended: 100mm):', '100');
  if (dist) {
    // Simulate API call
    setTimeout(() => {
      const mockOffset = Math.floor(Math.random() * 20) - 10; // Random offset for demo
      document.getElementById('offset_mm').value = mockOffset;
      showMessage('Offset calibration successful: ' + mockOffset + ' mm (Preview Mode)', 'success');
    }, 500);
  }
}

function calibrateXtalk() {
  const dist = prompt('Enter target distance in mm (recommended: 600mm):', '600');
  if (dist) {
    // Simulate API call
    setTimeout(() => {
      const mockXtalk = Math.floor(Math.random() * 1000);
      document.getElementById('xtalk_cps').value = mockXtalk;
      showMessage('Xtalk calibration successful: ' + mockXtalk + ' cps (Preview Mode)', 'success');
    }, 500);
  }
}

window.onload = function() { 
  loadConfig(); 
};
</script>
</body>
</html>

